---
- name: Download CNI rpm
  get_url:
    url: "{{ cni_url }}"
    dest: /tmp/cni.rpm
  when: use_local_file == false

- name: Install CNI
  yum:
    name: /tmp/cni.rpm
    state: present
  when: use_local_file == false

- name: Install local CNI
  yum:
    name: {{ cni_path }}
    state: present
  when: use_local_file == false

- name: Download OVS
  get_url:
    url: "{{ ovs_url }}"
    dest: /tmp/ovs.rpm
  when: use_local_file == false

- name: Download OVS kmod1
  get_url:
    url: "{{ ovs_kmod1_url }}"
    dest: /tmp/ovs_kmod.rpm
  when: use_local_file == false

- name: Download OVS kmod2
  get_url:
    url: "{{ ovs_kmod2_url }}"
    dest: /tmp/kmod_ovs.rpm
  when: use_local_file == false

- name: Install OVS
  yum:
    name: /tmp/ovs.rpm
    state: present
  tags: ovs
  when: use_local_file == false

- name: Install local OVS
  yum:
    name: {{ ovs_path }}
    state: present
  tags: ovs
  when: use_local_file == true

- name: Install OVS 2.6 Kernel Modules - 1
  yum:
    name: /tmp/ovs_kmod.rpm
    state: present
  tags: ovs
  when: use_local_file == false

- name: Install local OVS 2.6 Kernel Modules - 1
  yum:
    name: {{ ovs_kmod1_path }}
    state: present
  tags: ovs
  when: use_local_file == true

- name: Install OVS 2.6 Kernel Modules - 2
  yum:
    name: /tmp/kmod_ovs.rpm
    state: present
  when: use_local_file == false

- name: Install local OVS 2.6 Kernel Modules - 2
  yum:
    name: {{ ovs_kmod2_path }}
    state: present
  when: use_local_file == true

# https://docs.ansible.com/ansible/systemd_module.html
# systemctl start openvswitch.service
- name: Start OVS service
  systemd:
    name: openvswitch
    state: started

- name: Create OVS bridge
  openvswitch_bridge: bridge=br-int state=present fail_mode=standalone
  args:
    external_ids:
        bridge-id: "br-int"
  tags: ovs

- name: Add the Uplink Port to OVS
  openvswitch_port:
    bridge: br-int
    port: "{{ uplink_port }}"
    state: present
    set: Interface {{ uplink_port }} ofport_request=1
  tags: ovs

- name: Bring up br-int
  command: "ip link set br-int up"

- name: Bring up node-if
  command: "ip link set {{ uplink_port }} up"

## Get NCP tar file and make it docker image
- name: Download ncp image tar file
  get_url:
    url: "{{ ncp_image_url }}"
    dest: /tmp/nsx_ncp_rhel.tar
    force: no
  when: use_local_file == false

- name: Install docker-py 
  pip: 
    name: docker-py 

# Using docker_image to load tar file to docker image
- name: Load image from the image tar file
  docker_image:
    name: nsx_ncp_rhel
    timeout: 300
    state: present
    load_path: /tmp/nsx_ncp_rhel.tar
  when: use_local_file == false

- name: Load image from the local image tar file
  docker_image:
    name: nsx_ncp_rhel
    timeout: 300
    state: present
    load_path: {{ ncp_image_path }}
  when: use_local_file == true

- name: Register the docker image name
  shell: docker images | grep nsx-ncp-rhel
  register: nsx_ncp_rhel

- name: Tag image as nsx-ncp
  shell: docker tag "{{ nsx_ncp_rhel.stdout.split()[0] }}" nsx-ncp

- name: Download NCP yaml
  get_url:
    url: "{{ ncp_yaml_url }}"
    dest: /tmp/ncp-rc.yml
    force: yes
  when: use_local_file == false

- name: Copy NCP yaml to tmp
  command: cp {{ ncp_yaml_path }} /tmp/ncp-rc.yml
  when: use_local_file == true